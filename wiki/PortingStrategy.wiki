#summary Paint.NET Porting Strategy
#labels Phase-Deploy,plan,Phase-Implementation

= Basics =

Paint.NET has a very clean isolation between the engine and the system specific components.   

The ideal scenario is to ship a !SystemLayer.dll file that will replace the one that comes with the official distribution of Paint.NET.    Although I had originally hoped that the code could continue to support Mono and .NET on the same codebase, Rick suggested that I avoid this and go directly the route of replacing the library.

Ideally the port would only require the src/!SystemLayer directory to be ported but currently Paint.NET still contains a few places in the core engine that must be modified (for example, at startup the program checks the list of libraries and resources to be in the target directory, but some of these assemblies are not necessary for Linux or are useless on Linux) this has required some changes in the core of Paint.NET.

In places that must be revisited in the future (unfinished implementation, stubs, routines turned into no-ops) I have added a WriteLine statement so we can keep track of what is missing.   A complete port should produce no output on the console.

== Directions ==

The port is good enough to start the application, but many features are still not tested and there are many P/Invokes that remain in the source code.   I have not really spent much time trying to test it, but testing will exhibit many features that must be ported to Linux. 

What needs to be done:
* Test the application.
* File issues for every issue found.
** If it is a Paint.Net issue, file in http://code.google.com/p/paint-mono/issues/list
** If it is a Mono issue, file in http://www.mono-project.com/Bugs
* Provide fixes in either Paint.NET or Mono's Windows.Form implementation.

Repeat until we are done, and the application is working like a charm.

== Current State ==

It is currently possible to startup Paint.NET and do some simple painting operations, but I have not ported all of my changes from the old 2.72 port to 3.0 so there are many things that do not work.   I will post the old patch that I had here so that it can be used as a reference and to avoid duplicating work that was already done. 

Since Paint.NET is a .NET 2.0 application it is best if you use Mono 1.2.4, and ideally use the trunk release of Mono from subversion as the 2.0 support is rapidly evolving in that branch. 

== P/Invoke ==

There are a number of cases where Paint.NET is using P/Invoke, in some cases it is using functionality from the Windows OS that is available in Unix in a different form.  Porting this code should be pretty straight forward.

In some other cases the P/Invokes are used to call into features in the various Windows.Forms controls that is not exposed in the Windows.Forms API but is part of the underlying Win32 control.   In these cases, sometimes the functionality is also part of the internals of Mono's Managed Windows.Forms implementation.   In those cases you can access the internal features by using Reflection and Invoke, for example, consider this code that replaces the call to P/Invoke with an internal call

{{{
	MethodInfo drop_down = typeof (ComboBox).GetMethod ("DropDownListBox",
                BindingFlags.Instance|BindingFlags.NonPublic);
	if (drop_down == null){
		Console.WriteLine ("ShowComboBox: Warning, no DropDownlistBox found");
		return;
	}
	drop_down.Invoke (comboBox, new object [0]);
}}}

This was just an illustration, a better way is to just call the method that takes care of this on the comboBox:
{{{
        comboBox.Dropped = value;
}}}


= Building Paint.NET on Linux =

To build Paint.NET you will need to use Mono Develop from our subversion repository.  I know that this is suboptimal, but it is the only easy way of building Paint.NET without writing Makefiles from scratch.

To build it you must:
    * Open the src/paintdotnet.sln solution
    * Rebuild the solution.

I *welcome* any contributions along the lines of making this work with plain Makefiles, as it would solve some of the above mentioned problems.


= Original Source =

To track the changes and assist us in writing a 'Lessons in Porting' document, the original source code as obtained from http://www.getpaint.net is checked into this directory:

http://paint-mono.googlecode.com/svn/vendor/pdn_src_3_0

This is the vendor/pdn_src_3_0 branch.

= Contributing =

If you want to contribute to this effort, please mail me your login information, and I will add you to this project. 